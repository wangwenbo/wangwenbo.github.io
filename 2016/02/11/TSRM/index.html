<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> TSRM(线程安全) · Web PHP</title><meta name="description" content="A Blog Powered By Hexo"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/jekyll.css"><!--[if lt IE 9]>
<script src="js/html5shiv.min.js"></script>
<script src="js/respond.min.js"></script>
<![endif]--></head><body><header class="row-flex-row limit-width vh-center"><a href="/" class="logo"><img src="/favicon.png"></a><nav><ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-link">主页</a></li><li class="nav-list-item"><a href="/archives/" class="nav-link active">   博客</a></li><li class="nav-list-item"><a href="/atom.xml" class="nav-link">rss</a></li><li class="nav-list-item"><a href="https://github.com/xxxxx" target="_blank" class="nav-link">   github</a></li></ul></nav></header><div class="container limit-width"><section class="row-flex-row"><div class="post"><article class="post-block"><h2 class="post-title"><a href="/2016/02/11/TSRM/" class="post-title-link">TSRM(线程安全)</a></h2><div class="post-meta"><ul class="post-tag-list"><li class="post-tag-item"><a href="/tags/线程安全-全局变量/" class="post-tag-link">线程安全 全局变量</a></li></ul><div class="post-time">Friday, February 12th 2016</div></div><div class="post-content"><h3 id="TRSM的宏">TRSM的宏</h3><p>在查看源码的时经常会看到一个函数的参数中有这样一个宏TSRMLS_CC,而TSRMLS_CC表示启用线程安全。单线程中不存在线程安全的问题，但在多线程中这却是个问题，一个扩展启动后可能会被多个独立的请求同时调用。先看一下启用线程安全的宏：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> TSRMLS_D	void ***tsrm_ls</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> TSRMLS_DC	, TSRMLS_D</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> TSRMLS_C	tsrm_ls</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> TSRMLS_CC	, TSRMLS_C</span></span><br></pre></td></tr></table></figure>
<h3 id="扩展中的线程安全">扩展中的线程安全</h3><h4 id="申明全局变量">申明全局变量</h4><p>扩展中需要线程安全是因为其中有全局变量，扩展中申明全局变量的结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ZEND_BEGIN_MODULE_GLOBALS(wwb)</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> counter;</span><br><span class="line">ZEND_END_MODULE_GLOBALS(wwb)</span><br></pre></td></tr></table></figure>
<p>上述扩展wwb中的全局变量的生成是通过ZEND_BEGIN/END_MODULE_GLOBALS的宏来实现的，它展开如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> _zend_wwb_globals&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> counter;</span><br><span class="line">&#125; zend_wwb_globals wwb_globals</span><br></pre></td></tr></table></figure>
<h4 id="对全局变量的访问（线程安全与非线程安全）">对全局变量的访问（线程安全与非线程安全）</h4><p>其生命周期随着模块(MINIT)/请求（RINIT）的开始，随着MSHUTDOWN/RSHUTDOWN而结束。针对线程安全获取变量通过int wwb_globals_id:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#<span class="keyword">ifdef</span> ZTS</span></span><br><span class="line">	ts_allocate_id(&amp;wwb_globals_id,</span><br><span class="line">		<span class="keyword">sizeof</span>(zend_wwb_globals),</span><br><span class="line">		php_wwb_globals_ctor,php_wwb_globals_dctor);</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>分配的地址存储在vector中，通过wwb_globlas_id来索引；通过两个回调函数来完成初始化和资源回收。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">php_wwb_globals_ctor</span><span class="params">(zend_wwb_globals * wwb_globals TSRMLS_DC)</span></span>&#123;</span><br><span class="line">	wwb_globals-&gt;counter = <span class="number">0</span>;</span><br><span class="line">&#125;	</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">php_wwb_globals_dtor</span><span class="params">(zend_wwb_globals * wwb_globals TSRMLS_DC)</span></span>&#123;</span><br><span class="line">	<span class="comment">/*初始化时申请的资源 在在此处释放*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在非线程安全的情况下，直接访问wwb_globals。</p>
<p>最后来看一下，模块变量到底是何时启动和关闭的,上述内容是如何发挥作用的:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">PHP_MINIT_FUNCTION(wwb)&#123;</span><br><span class="line">	<span class="preprocessor">#<span class="keyword">ifdef</span> ZTS</span></span><br><span class="line">		ts_allocate_id(&amp;wwb_globals_id,</span><br><span class="line">			<span class="keyword">sizeof</span>(zend_wwb_globals),</span><br><span class="line">			(ts_allocate_ctor)php_wwb_globals_ctor,</span><br><span class="line">			(ts_allocate_dtor)php_wwb_globals_dtor);</span><br><span class="line">	<span class="preprocessor">#<span class="keyword">else</span></span></span><br><span class="line">		php_wwb_globals_ctor(&amp;wwb_globals TSRMLS_CC)</span><br><span class="line">	<span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">		<span class="keyword">return</span> SUCCESS;							</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PHP_MSHUTDOWN_FUNCTION(wwb)&#123;</span><br><span class="line">	<span class="preprocessor">#<span class="keyword">ifdef</span> ZTS</span></span><br><span class="line">		php_wwb_globals_dtor(&amp;wwb_globals TSRMLS_CC);</span><br><span class="line">	<span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line">		<span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>额外的补充一下：如何操作全局变量，不能像上面的代码一样每次ifdef的判断,  可以在php_wwb.h的头文件中定义宏：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">ifdef</span> ZTS</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">include</span> <span class="string">"TRSRM.h"</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> WWB_G(v)  TSRMG(wwb_globals_id,zend_wwb_globals*,v)</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#<span class="keyword">else</span></span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">define</span> WWB_G(v)  (wwb_globals.v)</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>其中v是zend_wwb_globals中的成员变量。</p>
</div></article><div class="pagination"><span class="pagination-prev">PREV</span><a href="/2016/01/03/网络函数-curl/" class="pagination-next">NEXT</a></div></div><aside class="sidebar"><h3>分类标签</h3><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP-strstr-stristr-substr/">PHP strstr,stristr,substr</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP7-ZVAL/">PHP7 ZVAL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP内核-变量/">PHP内核 变量</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP内核-变量-作用域-生命周期/">PHP内核 变量 作用域 生命周期</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/array-change-key-case-array-chunk/">array_change_key_case,array_chunk</a></li></ul><h3>最新文章</h3><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/02/11/TSRM/">TSRM(线程安全)</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/03/网络函数-curl/">PHP内核学习--curl</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/22/协程和mysql异步/">生成器和mysql异步</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/27/array-change-key-case-array-chunk/">PHP内核学习 --- 数组函数（键值大小写转换和切分）</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/22/ngigx-pfm/">nginx和php的pfm</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/15/pcntl-thread/">pcntl_thread</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/10/26/php7-2/">php7_2</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/10/25/有关缓存/">有关缓存</a></li></ul></aside></section></div><div class="extra"></div><footer class="footer"><div class="row-flex-row limit-width vh-center"><div class="copyright"><P>© 2016 <a href="/">阳关冰上</P></div><div class="power"><p><a href="http://pinggod.com/">Sean Sun</a>, 
<a href="https://hexo.io">Hexo</a>, 
<a href="https://github.com/">GitHub</a>, 
<a href="https://jekyllrb.com/">Jekyll</a></p></div></div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "//hm.baidu.com/hm.js?a36e15d9e2adec9a21fcdd9f686b1ed2";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>