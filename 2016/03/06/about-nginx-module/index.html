<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 初识nginx模块 · Web PHP</title><meta name="description" content="A Blog Powered By Hexo"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/jekyll.css"><!--[if lt IE 9]>
<script src="js/html5shiv.min.js"></script>
<script src="js/respond.min.js"></script>
<![endif]--></head><body><header class="row-flex-row limit-width vh-center"><a href="/" class="logo"><img src="/favicon.png"></a><nav><ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-link">主页</a></li><li class="nav-list-item"><a href="/archives/" class="nav-link active">   博客</a></li><li class="nav-list-item"><a href="/atom.xml" class="nav-link">rss</a></li><li class="nav-list-item"><a href="https://github.com/xxxxx" target="_blank" class="nav-link">   github</a></li></ul></nav></header><div class="container limit-width"><section class="row-flex-row"><div class="post"><article class="post-block"><h2 class="post-title"><a href="/2016/03/06/about-nginx-module/" class="post-title-link">初识nginx模块</a></h2><div class="post-meta"><ul class="post-tag-list"><li class="post-tag-item"><a href="/tags/配置nginx-conf/" class="post-tag-link">配置nginx.conf</a></li></ul><div class="post-time">Tuesday, March 8th 2016</div></div><div class="post-content"><h3 id="nginx的配置结构">nginx的配置结构</h3><p>nginx的核心是配置也就是nginx.conf的文件，nginx的配置大致可以分为如下几类：events，<br>http，server，location等几类配置块，而且http中可以嵌套server，location；除此之外，具体的配置内容会涉及内存、磁盘分配，mime类型，虚拟主机和请求分发等内容，就不再详细列举啦，可以阅读一下《Nginx模块开发与架构解析》的第二章内容。实例：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"> &#10;#user  nobody;&#10;worker_processes  1;   &#10;&#10;#error_log  logs/error.log;         &#10;#error_log  logs/error.log  notice;  //logs/error.log:&#38169;&#35823;&#26085;&#24535;&#36335;&#24452; notice:&#38169;&#35823;&#31867;&#22411;&#10;#error_log  logs/error.log  info;&#10;&#10;#pid        logs/nginx.pid;   //master&#36827;&#31243;&#25991;&#20214;&#10;&#10;&#10;events &#123;&#10;   &#9;worker_connections  1024;&#10;&#125;&#10;&#10;&#10;http &#123;&#10;   &#9;include       mime.types;&#10;   &#9;default_type  application/octet-stream;&#10;&#10;   &#9;sendfile        on;&#10;   &#9;#tcp_nopush     on;&#10;&#10;   &#9;#keepalive_timeout  0;&#10;   &#9;keepalive_timeout  65;&#10;&#10;   &#9;#gzip  on;&#10;&#10;   server &#123;&#10;       listen       80;&#10;       server_name  localhost;&#10;&#10;       #charset koi8-r;&#10;&#10;       #access_log  logs/host.access.log  main;&#10;&#10;       location / &#123;&#10;           root   html;&#10;           index  index.html index.htm;&#10;       &#125;&#10;&#10;       #error_page  404              /404.html;&#10;&#10;       # redirect server error pages to the static page /50x.html&#10;       #&#10;       error_page   500 502 503 504  /50x.html;&#10;       location = /50x.html &#123;&#10;           root   html;&#10;       &#125;&#10;&#10;   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="nginx模块的工作原理">nginx模块的工作原理</h3><p>针对http模块，nginx在接到一个http请求后，它会查找配置文件映射到对应的location块，然后根据location中配置的指令去启动不同的模块，再详细的的说这些模块中一个是handler模块和多个filter模块。handler模块负责处理和生成响应内容，filter模块负责过滤响应内容，就提的流程图：(此流程图来自：<a href="http://blog.codinglabs.org/articles/intro-of-nginx-module-development.html" target="_blank" rel="external">http://blog.codinglabs.org/articles/intro-of-nginx-module-development.html</a>)<br><img src="http://wangwenbo.github.io/image/nginx1.png" alt="nginx1 png"></p>
<h3 id="我们自己的http模块">我们自己的http模块</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10;location /test&#123;&#10;&#9;wwb;&#10;&#125;</span><br></pre></td></tr></table></figure>
<p>一个http模块的功能实现需要：<br>1.读入配置文件中的指令<br>2.http包装<br>3.响应结果</p>
<h4 id="模块配置结构体">模块配置结构体</h4><p>ngnix模块配置结构的命名规则ngx<em>http</em>[module-name]_[main|srv|loc]_conf_t, 其中main，server，location分别代表不同的配置块和层级，具体到这里我们的配置结构体命名为：ngx_http_wwb_loc_conf_t:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">typdef <span class="keyword">struct</span>&#123;</span><br><span class="line">	<span class="keyword">ngx_str_t</span> ed;</span><br><span class="line">&#125; <span class="keyword">ngx_http_wwb_loc_conf_t</span>;</span><br></pre></td></tr></table></figure>
<p>当配置中出现wwb时，nginx就会调用对应的ngx_http_wwb方法,在这个方法中我们可以重置handler方法，指向我们自定义模块的handler方法：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">char</span> * <span class="title">ngx_http_wwb</span><span class="params">(ngx_conf_t *cf, ngx_command_t *cmd, <span class="keyword">void</span> *conf)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">   	<span class="keyword">ngx_http_core_loc_conf_t</span>  *clcf;</span><br><span class="line">   	clcf = ngx_http_conf_get_module_loc_conf(cf, ngx_http_core_module);</span><br><span class="line">   	<span class="comment">/* HTTP框架在处理用户请求进行到NGX_HTTP_CONNENT_PHASE阶段是，如果请求的主机域名、URI与wwb配置项所在的配置块匹配，就将调用我们实现的ngx_http_wwb_handler方法处理这个请求 */</span></span><br><span class="line">   	clcf-&gt;handler = ngx_http_wwb_handler;</span><br><span class="line">   	ngx_conf_set_str_slot(cf,cmd,conf);</span><br><span class="line">   	<span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="自定义模块">自定义模块</h4><p>我们自定义的模块也要加入到ngx_modules这个全局数组中，在Nginx启动时，自定义模块和其他模块一起初始化。这包含两个结构体：ngx_http_wwb_module_ctx和ngx_http_wwb_module,如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/* Http context of the module */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">ngx_http_module_t</span>  ngx_http_wwb_module_ctx = &#123;</span><br><span class="line">   	<span class="literal">NULL</span>,                                  <span class="comment">/* preconfiguration */</span></span><br><span class="line">   	<span class="literal">NULL</span>,                                  <span class="comment">/* postconfiguration */</span></span><br><span class="line">   	<span class="literal">NULL</span>,                                  <span class="comment">/* create main configuration */</span></span><br><span class="line">   	<span class="literal">NULL</span>,                                  <span class="comment">/* init main configuration */</span></span><br><span class="line">   	<span class="literal">NULL</span>,                                  <span class="comment">/* create server configuration */</span></span><br><span class="line">   	<span class="literal">NULL</span>,                                  <span class="comment">/* merge server configuration */</span></span><br><span class="line">   	ngx_http_wwb_create_loc_conf,         <span class="comment">/* create location configration */</span></span><br><span class="line">   	ngx_http_echo_merge_loc_conf           <span class="comment">/* merge location configration */</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* Module */</span></span><br><span class="line"><span class="keyword">ngx_module_t</span>  ngx_http_wwb_module = &#123;</span><br><span class="line">  	 	NGX_MODULE_V1,</span><br><span class="line">   	&amp;ngx_http_wwb_module_ctx,              <span class="comment">/* module context */</span></span><br><span class="line">   	ngx_http_wwb_commands,                 <span class="comment">/* module directives */</span></span><br><span class="line">   	NGX_HTTP_MODULE,                       <span class="comment">/* module type */</span></span><br><span class="line">   	<span class="literal">NULL</span>,                                  <span class="comment">/* init master */</span></span><br><span class="line">   	<span class="literal">NULL</span>,                                  <span class="comment">/* init module */</span></span><br><span class="line">   	<span class="literal">NULL</span>,                                  <span class="comment">/* init process */</span></span><br><span class="line">   	<span class="literal">NULL</span>,                                  <span class="comment">/* init thread */</span></span><br><span class="line">   	<span class="literal">NULL</span>,                                  <span class="comment">/* exit thread */</span></span><br><span class="line">  	 	<span class="literal">NULL</span>,                                  <span class="comment">/* exit process */</span></span><br><span class="line">   	<span class="literal">NULL</span>,                                  <span class="comment">/* exit master */</span></span><br><span class="line">   	NGX_MODULE_V1_PADDING</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="合并配置项">合并配置项</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> * <span class="title">ngx_http_wwb_create_loc_conf</span><span class="params">(ngx_conf_t *cf)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">   	<span class="keyword">ngx_http_wwb_loc_conf_t</span>  *conf;</span><br><span class="line">   	conf = ngx_pcalloc(cf-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_http_wwb_loc_conf_t</span>));</span><br><span class="line">  	 	<span class="keyword">if</span> (conf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">       	<span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">   	&#125;</span><br><span class="line">   	conf-&gt;ed.len = <span class="number">0</span>;</span><br><span class="line">   	conf-&gt;ed.data = <span class="literal">NULL</span>;</span><br><span class="line">   	<span class="keyword">return</span> conf;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">char</span> * <span class="title">ngx_http_wwb_merge_loc_conf</span><span class="params">(ngx_conf_t *cf, <span class="keyword">void</span> *parent, <span class="keyword">void</span> *child)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">   	<span class="keyword">ngx_http_wwb_loc_conf_t</span> *prev = parent;</span><br><span class="line">   	<span class="keyword">ngx_http_wwb_loc_conf_t</span> *conf = child;</span><br><span class="line">   	ngx_conf_merge_str_value(conf-&gt;ed, prev-&gt;ed, <span class="string">""</span>);</span><br><span class="line">   	<span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="自定义模块的handler方法">自定义模块的handler方法</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/* Handler function */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> ngx_int_t <span class="title">ngx_http_wwb_handler</span><span class="params">(ngx_http_request_t *r)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">   <span class="keyword">ngx_int_t</span> rc;</span><br><span class="line">   <span class="keyword">ngx_buf_t</span> *b;</span><br><span class="line">   <span class="keyword">ngx_chain_t</span> out;</span><br><span class="line">   <span class="keyword">ngx_http_echo_loc_conf_t</span> *elcf;</span><br><span class="line">   elcf = ngx_http_get_module_loc_conf(r, ngx_http_wwb_module);</span><br><span class="line">   <span class="keyword">if</span>(!(r-&gt;method &amp; (NGX_HTTP_HEAD|NGX_HTTP_GET|NGX_HTTP_POST)))</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">return</span> NGX_HTTP_NOT_ALLOWED;</span><br><span class="line">   &#125;</span><br><span class="line">   r-&gt;headers_out.content_type.len = <span class="keyword">sizeof</span>(<span class="string">"text/html"</span>) - <span class="number">1</span>;</span><br><span class="line">   r-&gt;headers_out.content_type.data = (u_char *) <span class="string">"text/html"</span>;</span><br><span class="line">   r-&gt;headers_out.status = NGX_HTTP_OK;</span><br><span class="line">   r-&gt;headers_out.content_length_n = elcf-&gt;ed.len;</span><br><span class="line">   <span class="keyword">if</span>(r-&gt;method == NGX_HTTP_HEAD)</span><br><span class="line">   &#123;</span><br><span class="line">       rc = ngx_http_send_header(r);</span><br><span class="line">       <span class="keyword">if</span>(rc != NGX_OK)</span><br><span class="line">       &#123;</span><br><span class="line">           <span class="keyword">return</span> rc;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   b = ngx_pcalloc(r-&gt;pool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_buf_t</span>));</span><br><span class="line">   <span class="keyword">if</span>(b == <span class="literal">NULL</span>)</span><br><span class="line">   &#123;</span><br><span class="line">       ngx_log_error(NGX_LOG_ERR, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">"Failed to allocate response buffer."</span>);</span><br><span class="line">       <span class="keyword">return</span> NGX_HTTP_INTERNAL_SERVER_ERROR;</span><br><span class="line">   &#125;</span><br><span class="line">   out.buf = b;</span><br><span class="line">   out.next = <span class="literal">NULL</span>;</span><br><span class="line">   b-&gt;pos = elcf-&gt;ed.data;</span><br><span class="line">   b-&gt;last = elcf-&gt;ed.data + (elcf-&gt;ed.len);</span><br><span class="line">   b-&gt;memory = <span class="number">1</span>;</span><br><span class="line">   b-&gt;last_buf = <span class="number">1</span>;</span><br><span class="line">   rc = ngx_http_send_header(r);</span><br><span class="line">   <span class="keyword">if</span>(rc != NGX_OK)</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="keyword">return</span> rc;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> ngx_http_output_filter(r, &amp;out);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></article><div class="pagination"><span class="pagination-prev">PREV</span><a href="/2016/02/28/about-redis/" class="pagination-next">NEXT</a></div></div><aside class="sidebar"><h3>分类标签</h3><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP-strstr-stristr-substr/">PHP strstr,stristr,substr</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP7-ZVAL/">PHP7 ZVAL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP内核-变量/">PHP内核 变量</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP内核-变量-作用域-生命周期/">PHP内核 变量 作用域 生命周期</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/array-change-key-case-array-chunk/">array_change_key_case,array_chunk</a></li></ul><h3>最新文章</h3><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/03/06/about-nginx-module/">初识nginx模块</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/28/about-redis/">初识redis</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/13/http-cache/">http 缓存</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/02/11/TSRM/">TSRM(线程安全)</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/01/03/网络函数-curl/">PHP内核学习--curl</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/12/22/协程和mysql异步/">生成器和mysql异步</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/27/array-change-key-case-array-chunk/">PHP内核学习 --- 数组函数（键值大小写转换和切分）</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/11/22/ngigx-pfm/">nginx和php的pfm</a></li></ul></aside></section></div><div class="extra"></div><footer class="footer"><div class="row-flex-row limit-width vh-center"><div class="copyright"><P>© 2016 <a href="/">阳关冰上</P></div><div class="power"><p><a href="http://pinggod.com/">Sean Sun</a>, 
<a href="https://hexo.io">Hexo</a>, 
<a href="https://github.com/">GitHub</a>, 
<a href="https://jekyllrb.com/">Jekyll</a></p></div></div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "//hm.baidu.com/hm.js?a36e15d9e2adec9a21fcdd9f686b1ed2";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>